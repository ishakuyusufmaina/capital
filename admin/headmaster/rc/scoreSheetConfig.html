<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Score Sheet Config</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background: #f9fafb;
    }
    h1, h2 {
      text-align: center;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem auto;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    label {
      display: block;
      margin: 0.5rem 0 0.2rem;
      font-weight: bold;
    }
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 0.5rem;
    }
    button {
      margin: 0.2rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-primary { background: #3b82f6; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-secondary { background: #6b7280; color: white; }
    ul {
      list-style: none;
      padding: 0;
    }
    li {
      background: #f3f4f6;
      padding: 0.8rem;
      margin-bottom: 0.5rem;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .actions button {
      margin-left: 0.3rem;
    }
  
  select {
  appearance: none;          /* remove default browser style */
  -webkit-appearance: none;
  -moz-appearance: none;
  
  background-color: #fff;    /* white background */
  border: 1px solid #ddd;    /* light border */
  border-radius: 8px;        /* rounded corners */
  padding: 0.5rem 2rem 0.5rem 0.8rem; /* space for text + arrow */
  font-size: 1rem;
  font-family: inherit;
  color: #333;
  cursor: pointer;

  box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* soft shadow */
  transition: border-color 0.2s ease, box-shadow 0.2s ease;
  width: 100%; /* optional: make it full width */
}

select:focus {
  outline: none;
  border-color: #3b82f6;   /* blue border on focus */
  box-shadow: 0 0 0 3px rgba(59,130,246,0.3);
}

select:hover {
  border-color: #aaa;
}

/* custom arrow */
select {
  background-image: url("data:image/svg+xml;utf8,<svg fill='%23666' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
  background-repeat: no-repeat;
  background-position: right 0.6rem center;
  background-size: 1rem;
  text-transform: uppercase;
}
  </style>
</head>
<body>
  
  <h1>Score Sheet Config</h1>
  <div class="card">
    <select id="sectionSelect">
    <option value="">-select section-</option>
  </select>
    <label>Exam:</label>
    <input type="number" id="totalInput" value="0">
    <button class="btn-primary" id="updateTotalBtn" onclick="updateTotal()">Update Total</button>
    <p><strong>Current Total:</strong> <span id="totalDisplay">0</span></p>
  </div>

  <div class="card">
    <h3>Assessments</h3>
    <ul id="assessmentsList"></ul>
    <h4>Add Assessment</h4>
    <input type="text" id="newName" placeholder="Assessment name">
    <input type="number" id="newSubtotal" placeholder="Subtotal">
    <button class="btn-primary" id="add" onclick="addAssessment()">Add</button>
  </div>
  
  
  <div class="card">
    <h3>Derived Assessments</h3>
    <ul id="derivedAsmList">
      <li>
        <input type="text" id="newDName" placeholder="Assessment name">
        <select id="derivatives" multiple>
          <optgroup label="Derivatives">
            
          </optgroup>
        </select>
      </li>
    </ul>
    <button class="btn-primary" id="addDAsm" onclick="addDerivedAsm()">Add</button>
  </div>
  
  <div class="card">
    <button class="btn-primary" id="save" onclick="saveAssessment()">Save</button>
    <button class="btn-warning" id="reset" onclick="resetAssessments()">Reset All</button>
  </div>
  <hr>
  <div class="card">
    <a href="configuration.html">Report Card Configuration</a>
  </div>
  


  
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, doc, setDoc, getDoc, serverTimestamp} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, updateProfile, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
     // import {getDatabase, set, ref, onValue, child, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
      const firebaseConfig = {
  apiKey: "AIzaSyCm_DSZaYVQCt0ubBwRkE9nOTryJayxH0w",
  authDomain: "school-in-the-box.firebaseapp.com",
  projectId: "school-in-the-box",
  storageBucket: "school-in-the-box.firebasestorage.app",
  messagingSenderId: "596350496353",
  appId: "1:596350496353:web:84c66c351700ddf0824420",
  measurementId: "G-3MGCDH4FRF"
};
  
  const schoolId = "capital";
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
    const db = getFirestore(app);
   let sections = (await getDoc(doc(db, schoolId, "section"))).data();
  let user = auth.currentUser;
  let id = user.email.replace(/@.*/, "");
let hos = (await getDoc(doc(db, schoolId, "db", "staff", id))).data();  
let rroles = hos.roles.filter(role=>role.code=="hosec");
let sectIds = rroles.map(role=>role.resource.section);
  console.log(sectIds);

  //Object.keys(sections)
  sectIds.forEach(sectId=>{
    let opt = new Option(sectId);
    opt.value = sectId;
    sectionSelect.append(opt);
  })
    let scoreSheetConfig; /* = {
      total: 100,
      assessments: [
        { name: "1st CA", subtotal: 10 },
        { name: "2nd CA", subtotal: 20 }
      ]
    };*/
  
  sectionSelect.onchange = e=>{
    if (!e.target.value) return;
    let section = sections[e.target.value];
    section.scoreSheetConfig??={
      exam: 70,
      assessments: [
      {name: "test", subtotal: 30}
      ]/*,
      derivedAsms: [
      {name: "CA", derivatives:["test"]}
      ]*/
    };
   scoreSheetConfig = section.scoreSheetConfig;
    scoreSheetConfig.derivedAsms??= [
      {name: "CA", derivatives: []}
      ];
    render();
  }

    function render() {
      updateTotal() 
    //  document.getElementById("totalDisplay").innerText = scoreSheetConfig.exam;
      let examIn = document.getElementById("totalInput")
      examIn.value = scoreSheetConfig.exam;
      examIn.onchange = e=>  scoreSheetConfig.exam = examIn.value;
      let list = document.getElementById("assessmentsList");
      list.innerHTML = "";
  
      scoreSheetConfig.assessments.forEach((a, index) => {
   
        const li = document.createElement("li");
        li.innerHTML = `
          <div>
            <strong>${a.name}</strong> - ${a.subtotal}
          </div>
          <div class="actions">
            <button class="btn-secondary edit" onclick="editAssessment(${index})">Edit</button>
            <button class="btn-danger delete" onclick="deleteAssessment(${index})">Delete</button>
          </div>
        `;
        li.querySelector(".edit").onclick = e=> editAssessment(index);
        li.querySelector(".delete").onclick = e=> deleteAssessment(index);
        
        list.appendChild(li);
      });
      
      list = document.getElementById("derivedAsmList");
      list.innerHTML = "";
      scoreSheetConfig.derivedAsms.forEach((a, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
        <input type="text" value="${a.name}" class="derivedName" placeholder="Assessment name">
        <select class="derivatives" multiple>
          <optgroup label="Derivatives">            
          </optgroup>
        </select>
        `;
        let select = li.querySelector("select");
        a.derivatives??=[];
        scoreSheetConfig.assessments.forEach(asm=>{
         let d = asm.name;
          let opt = new Option(d);
          opt.selected = a.derivatives.includes(d);
          select
          .querySelector("optgroup")
          .append(opt);
        })
        select.onchange = e=>{
          a.derivatives = Array.from(select.selectedOptions).map(opt=>opt.value);
        }
        list.appendChild(li);
      });
    }

  updateTotalBtn.onclick = updateTotal;
    function updateTotal() {
     // const totalVal = document.getElementById("totalInput").value;
      let total = Number(scoreSheetConfig.exam);
     scoreSheetConfig.assessments.forEach(asm=> total +=Number(asm.subtotal));
      document.getElementById("totalDisplay").innerText = total;  
    //  render();
    }

  add.onclick = addAssessment;
  addDAsm.onclick = addDerivedAsm;
    function addAssessment() {
      const name = document.getElementById("newName").value.trim();
      const subtotal = Number(document.getElementById("newSubtotal").value);
      if (!name || isNaN(subtotal)) return alert("Please provide valid inputs.");
      scoreSheetConfig.assessments.push({ name, subtotal });
      document.getElementById("newName").value = "";
      document.getElementById("newSubtotal").value = "";
      render();
    }
  
  function addDerivedAsm() {
      const name = "";//document.getElementById("newName").value.trim();
      const derivatives = []; //Number(document.getElementById("newSubtotal").value);
      //if (!name || isNaN(subtotal)) return alert("Please provide valid inputs.");
      scoreSheetConfig.derivedAsms.push({ name, derivatives });     
      render();
    }

 
    function editAssessment(index) {
      const a = scoreSheetConfig.assessments[index];
      const newName = prompt("Enter new name:", a.name);
      const newSubtotal = prompt("Enter new subtotal:", a.subtotal);
      if (newName !== null && newSubtotal !== null) {
        scoreSheetConfig.assessments[index] = {
          name: newName.trim() || a.name,
          subtotal: Number(newSubtotal) || a.subtotal
        };
        render();
      }
    }

  
    function deleteAssessment(index) {
      if (confirm("Are you sure you want to delete this assessment?")) {
        scoreSheetConfig.assessments.splice(index, 1);
        render();
      }
    }

  reset.onclick = resetAssessments;
    function resetAssessments() {
      if (confirm("Reset all assessments?")) {
        scoreSheetConfig.assessments = [];
        render();
      }
    }
  
  save.onclick = async e=>{
    let section = sections[sectionSelect.value];
    console.log(JSON.stringify(section.scoreSheetConfig));
    let conf = section.scoreSheetConfig;
    let total = Number(conf.total);
    let subtotals = Object.values(conf.assessments).map(asm=>asm.subtotal);
  //  let sumSubtotals = subtotals.reduce((acc, val)=> acc +=Number(val));
  //  console.log(sumSubtotals);
    if (false) {
      alert("Sum of subtotals must be equal to total!"); 
      return
    } else {
      await setDoc(doc(db, schoolId, "section"), sections);
      alert("seved!");
    }
  }
  
  
  function addHeading(){
    
  }
    
  </script>

</body>
</html>