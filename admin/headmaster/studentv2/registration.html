<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="reg.css">
  <title>New Student Registration</title>
  
  <style>
    
  

:root {
      --primary: #2563eb;
      --background: #f3f4f6;
      --text: #1f2937;
      --border: #d1d5db;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 2rem;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--background);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      
    }
  #session {
    position: absolute;
    top: 0;
  }

#status {
    position: fixed;
    background: white;
  padding: 2rem;
  border-radius: 1.5rem;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  max-width: 320px;
  width: 90%;
  text-align: center;
  font-family: "Segoe UI", sans-serif;
  animation: fadeInScale 0.3s ease-in-out;
    left: 20px;
    top: 20px;
    
    
  }
  
  :empty#status {
  display: none;
}

    .card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      max-width: 700px;
      width: 100%;
      overflow: hidden;
      padding: 2rem;
    }

    .top {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .top img {
      width: 130px;
      height: 130px;
      border-radius: 15px;
      object-fit: cover;
      margin-bottom: 1rem;
     // border: 4px solid var(--primary);
    }

    .upload-img {
      margin-bottom: 1rem;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      font-weight: bold;
      margin-bottom: 0.4rem;
    }

    .form-group input,
    .form-group select {
      padding: 0.5rem;
      border: 1px solid var(--border);
      border-radius: 0.4rem;
      font-size: 1rem;
    }

    .submit-btn {
      margin-top: 1.5rem;
      text-align: center;
    }

    .submit-btn button, button {
      background-color: var(--primary);
      color: white;
      padding: 0.75rem 2rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.5rem;
      cursor: pointer;
    }

.loader {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(6px);
  background-color: rgba(255, 255, 255, 0.5);
}

.ripple {
  position: relative;
  width: 80px;
  height: 80px;
}

.ripple::before,
.ripple::after {
  content: "";
  position: absolute;
  inset: 0;
  border: 4px solid #007bff;
  border-radius: 50%;
  animation: rippleAnim 1.5s infinite;
}

.ripple::after {
  animation-delay: 0.75s;
}

    @media (max-width: 600px) {
      .card {
        padding: 1.5rem;
      }
    }
  


@keyframes rippleAnim {
  0% {
    transform: scale(0.5);
    opacity: 1;
  }
  100% {
    transform: scale(2);
    opacity: 0;
  }
}
  
  .show.iframe-container {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;  
    width: 100%;
    height: 100%;    
    background: white;
  }
  .iframe-container > iframe {
    width: 100%;
    height: 100%;
    
  }
    #close {
      margin-top: 10px;
      background: none;
      color: red;
  }
  #newParent, #linkParent {
    display: inline-block;
    margin: 6px;
  }



  
  

  </style>
</head>
<body>
<div id="session">Session: </div>
  <div class="card">
    <div class="top">
      <img src="" alt="Passport" id="profilePreview">
      <input type="file" accept="image/*" id="profilePicInput" class="upload-img" required>
      <h2>New Student Registration</h2>
    </div>
    <div id="status"></div>
    <form id="registrationForm">
      <div class="form-group">
        <label for="name">Name</label>
        <input type="text" id="name" name="name" placeholder="Enter full name" required>
      </div>

      <div class="form-group">
        <label for="gender">Gender</label>
        <select id="gender" name="gender" required>
          <option value="">Select</option>
          <option>Male</option>
          <option>Female</option>
          
        </select>
      </div>

      <div class="form-group">
        <label for="dob">Date of Birth</label>
        <input type="date" id="dob" name="dob" required>
      </div>
      
      <div class="form-group">
        <label for="pob">Place of Birth</label>
        <input  id="pob" name="pob" required>
      </div>
      
      
      
        <div class="form-group">
        <label for="nationality">Nationality</label>
        <select type="date" id="nationality" name="nationality" required>
          <option value="">-nationality-</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="state">State</label>
        <select id="state" name="state" required>
          <option value="">-state-</option>
        </select>
      </div>
      <div class="form-group">
        <label for="lga">LGA</label>
        <select id="lga" name="lga" required>
          <option value="">-LGA-</option>
        </select>
      </div>
      
      

      <div class="form-group">
        <label for="std-status">Status</label>
        <select id="std-status" name="status" required>
          <option value="">Select</option>
          <option selected>Active</option>
          <option>Graduated</option>
          <option>Transfered</option>
          <option>Defaulter</option>
          <option>Suspended</option>
          <option>Dismissed</option>
        </select>
      </div>

      <div class="form-group">
        <label for="classes">Class</label>
        <select id="class" name="class" required>
          <!--option value="">Select Class</option-->          
        </select>
      </div>



      <div class="form-group">
        <label for="house">House</label>
        <select id="house" name="house" required>
          <option value="">Select House</option>
          <option value="red">Red</option>
          <option value="green">Green</option>
          <option value="blue">Blue</option>
          <option value="yellow">Yellow</option>
          

          

          
        </select>
      </div>
      
      <div class="form-group">
        <label for="pin">PIN (<small>Parent Identification Number</small>)</label>
        <input id="pin" type="number" required>
        <button type="button" id="newParent">New parent? Register</button>
        <div id="parent">
          <button id="linkParent" type="button">Check</button>        
        </div>
      </div>

      
        
      <hr>
      <div class="submit-btn">
        <button type="submit">Register</button>
      </div>
    </form>
  </div>

  <div class="loader">
  <div class="ripple"></div>
</div>
  
  <div class="iframe-container">
    
  </div>
  <script src="lga.js"></script>
<script type="module">
  /*
  precondition: session must be already created;
  */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, doc, serverTimestamp, setDoc, getDoc, runTransaction} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
     // import {getDatabase, set, ref, onValue, child, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
      const firebaseConfig = {
  apiKey: "AIzaSyCm_DSZaYVQCt0ubBwRkE9nOTryJayxH0w",
  authDomain: "school-in-the-box.firebaseapp.com",
  projectId: "school-in-the-box",
  storageBucket: "school-in-the-box.firebasestorage.app",
  messagingSenderId: "596350496353",
  appId: "1:596350496353:web:84c66c351700ddf0824420",
  measurementId: "G-3MGCDH4FRF"
};
  
  
  const schoolId="capital";
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
    const db = getFirestore(app);

  linkParent.onclick = async e=>{
    parent = linkParent.parentElement;
    let p = pin.value;
    console.log(p);
    
    let info = document.createElement("div");
    if (parent.children[1]) parent.children[1].remove();
info.innerHTML = "Checking...";
    let parentDoc;
    try {
    parentDoc = await getDoc(doc(db, schoolId, "db", "parents", "pin"+p.trim()));
    } catch(e){
      info.innerHTML = "Error occured. try again.";
    }
       parent.append(info);
    if (parentDoc.exists()){
      let par = parentDoc.data();
      info.innerHTML = `
      Parent Name: ${par.fullname}<br>
      Parent ID: ${par.id}
      `;
      
    } else {
      info.innerHTML = "No such parent found";
    }
    
  }
  newParent.onclick = e=>{
   let elm =  document.
    querySelector(".iframe-container");
    elm.innerHTML = `
    <button id="close">Close</button>
    <iframe src="../parent/registration.html"></iframe>
    `;
    elm.classList.add("show");
    elm.querySelector("#close")
    .onclick = e=> {
      elm.innerHTML = "";
      elm.classList.remove("show");
      newParent.scrollIntoView();
    }
  }
    
    const terms = ["first term", "second term", "third term"];
  let sessionsRef = doc(db, schoolId, "sessions");
  //let studentsRef = doc(db, schoolId, "classes");
  let sessionsDoc = await getDoc(sessionsRef);
  document.querySelector(".loader").style.display = "none";
 
  fetchAllCountries(nationality);
  nationality.value = "Nigeria";
  nationality.onchange = _=>{
    let v = nationality.value;
    if (v){
      getStates(v, state);
    }
  }
  if (sessionsDoc.exists()){
    let sessions =  sessionsDoc.data().sessions;
     sessions= sessions.sort((a, b)=>b.no - a.no);
   /* sessions.forEach((session, i)=>{
        let year = session.year;
      let opt = document.createElement("option");
      opt.innerHTML = year + ", " + terms[session.term];
      sessionSelect.appendChild(opt);
        if (i==0)
        
        opt.selected = true;
    });*/
    session.innerText = sessions[0].year + ", " + terms[sessions[0].term];
    session.dataset.year = sessions[0].year;
    session.dataset.term = sessions[0].term;
    
      //sessionSelect.firstChild.nextElementSibling.selected = true;
  }
  
 let registrant  = localStorage.getItem("registrant");
   localStorage.clear("registrant");
const elm = (id)=>document.getElementById(id);
  console.log(registrant);
 if (registrant){
   registrant = JSON.parse(registrant);
   assert(!registrant.registered, "Registrant already registered!");
   elm("name").value = registrant.name;
  // elm("gender").innerHTML = `<option>${registrant.gender}</option>`;

 }
  let sectionRef = doc(db, schoolId, "section");
  var timeoutId;
  let classSelect = document.getElementById("class");
  if (!registrant){
    let sections = await getDoc(sectionRef);
  if (sections.exists()){
    let sectData = sections.data();
    for (const sectId in sectData){
      let section = sectData[sectId];
      let classes = section.classes;
      let classGroup = document.createElement("optgroup");
      classGroup.label = sectId.toUpperCase();
      classSelect.append(classGroup);
      classes.forEach(cls=>{
        let opt = new Option(cls);
        //console.log(classSelect);
        classGroup.append(opt);
      })
    }
  }
  } else {
    classSelect.innerHTML = `<option selected>${registrant.class}</option>`;
  }
    // Image preview
    document.getElementById("profilePicInput").addEventListener("change", function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          document.getElementById("profilePreview").src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // Form submission
    document
  .getElementById("registrationForm")
  .addEventListener("submit", async function (e) {
      e.preventDefault();
      const picURL = await uploadFile();
     if (picURL == 0) return; //no passport
     if (picURL == 1) return; //an error occurred;    
      const name = document.getElementById("name").value.trim().toLowerCase();
      const gender = document.getElementById("gender").value;
      const dob = document.getElementById("dob").value;
      const status = document.getElementById("std-status").value;
     // const studentClass = document.getElementById("classes").value;
      const house = document.getElementById("house").value;

    
  /*    alert(
        "New Student Registered:\n\n" +
        "Name: " + name + "\n" +
        "Gender: " + gender + "\n" +
        "Date of Birth: " + dob + "\n" +
        "Status: " + status + "\n" +
        "Class: " + studentClass + "\n" +
        "passportURL: " + picURL + "\n"
      );
    */
    
    let names = name.split(" ");
    console.log(names);
    let stdProfile = {
      name, gender, dob, status,
      picURL, house, timestamp:serverTimestamp()
    }
    //stdProfile.class = studentClass.toLowerCase();
    stdProfile.names = names;
    stdProfile.asApplicant = registrant;
    stdProfile.pin = document.getElementById("pin").value;
    console.log(JSON.stringify(stdProfile));
    runTransaction(db, async (transaction)=>{
      let sesK = key(session.dataset.year+terms[session.dataset.term]);
      console.log(sesK);
      let sessionRef = doc(db, schoolId, sesK);
      let sessionDoc = await transaction.get(sessionRef);
      let lastId;
      if (!sessionDoc.exists()){       
        await transaction.set(sessionRef, {lastStudentId:0});
        lastId = 0;
      } else {
          let sessionData = sessionDoc.data();
          lastId = sessionData.lastStudentId;
      }
      
      let lastStudentId = Number(lastId)+1;
     await transaction.set(sessionRef, {lastStudentId}, {merge:true});
      let years = session.dataset.year.trim().replaceAll(" ", "").split("/");
      let y1 = years[0].slice(2, 4);
      let y2 = years[1].slice(2, 4);
     let newId = `${y1}/${y2}/0${Number(session.dataset.term)+1}/${lastStudentId}`.replaceAll(" ", "");
     stdProfile.id = newId;
  //   stdProfile.dateCreated = 
      stdProfile.registra = {
        name: auth.currentUser.displayName,
        id: auth.currentUser.email
      }
      console.log(stdProfile.registra)
      let studentRef = doc(db, schoolId, "db", "students",  key(newId));
      let ref = doc(db, schoolId, "db", "applications", `year${session.year}term${session.term}`);
      
      let formData = new FormData(this);
      formData.forEach((v, k)=>stdProfile[k]=v);
     // stdProfile.class = formData.getAll("class");
      //console.log(JSON.stringify(formData))
     await transaction.set(studentRef, stdProfile);
          
      //let ref = doc(db, schoolId, "db", "applications", `year${session.year}term${session.term}`);

     let st= document.getElementById("status");
      clearTimeout(timeoutId);
      st.innerText = "A new student with id "+newId+" has been successfully registerred.";
      this.reset();
       timeoutId = setTimeout(_=>st.innerText = "", 5000);     
      
      document.getElementById("profilePreview").src = "";
      console.log(newId);
    })
  });
  
  
  
  async function uploadFile() {
      const fileInput = document.getElementById("profilePicInput");
      const file = fileInput.files[0];

      if (!file) {
        let status = document.getElementById("status");
        clearTimeout(timeoutId);
        status.innerText="Please upload student passport.";
        timeoutId = setTimeout(_=>status.innerText = "", 2000);        
        return 0;
      }

      const cloudName = "daktkkz2k"; // Replace with your Cloudinary cloud name
      const uploadPreset = "passport"; // Replace with your unsigned preset

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);

      const status = document.getElementById("status");
      status.innerText = "Uploading...";

      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
          method: "POST",
          body: formData
        });

        const data = await response.json();
        console.log("Uploaded file:", data);
        clearTimeout(timeoutId);
        status.innerText = "Upload successful!";
        timeoutId = setTimeout(_=>status.innerText = "", 2000);

       /* const img = document.getElementById("preview");
        img.src = data.secure_url;
        img.style.display = "block";*/
        return data.secure_url;
      } catch (error) {
        console.error("Upload failed:", error);
        clearTimeout(timeoutId);
        status.innerText = "Upload failed.";
       timeoutId = setTimeout(_=>status.innerText = "", 2000);
        return 1; //error
      }
    }
  
  
  
  function key(token){
      return token.replaceAll(" ","").replaceAll("/", "").replaceAll(",", "").trim();
    }
function assert(condition, message) {
  if (!condition) {
    alert(message);
    throw new Error(message || "Assertion failed");
  }
}

  function fetchAllCountries(select){
       // Fetch all countries
    fetch("https://countriesnow.space/api/v0.1/countries")
      .then(res => res.json())
      .then(data => {
        select.innerHTML = `<option value="">-- Select a Country --</option>`;
        data.data.forEach(country => {
          const option = document.createElement("option");
          option.value = country.country;
          if (country.country == "Nigeria"){
             option.selected = true;
            getStates("Nigeria", state);
          }
          option.textContent = country.country;
          select.appendChild(option);
        });
      });

  }
  
  
      // Fetch states for selected country
    function getStates(country, stateSelect) {
      stateSelect.innerHTML = "<option value=''>None</option>";
      console.log(country);
      const selectedCountry = country;  // countrySelect.value;
      if (!selectedCountry) {
        alert("Please select a country.");
        return;
      }
      
      fetch("https://countriesnow.space/api/v0.1/countries/states", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ country: selectedCountry })
      })
      .then(res => res.json())
      .then(data => {
        const states = data.data.states;
        if (states.length === 0) {
          stateSelect.innerHTML = "<option>N/A</option>";
          return;
        }

        const list = states.forEach(s => {
          let opt = new Option(s.name);
          stateSelect.append(opt);
        });
        lga.innerHTML = "";
        if (selectedCountry=="Nigeria"){
          
        stateSelect.onchange = e=>{
          if (stateSelect.value){
            lga.innerHTML = "";
            let s = stateSelect.value;
            console.log(lgas);
            console.log(s);
            console.log(Object.keys(lgas))
            let ls = lgas[s.replace(" State", "")];
            
            console.log(ls);
            ls.forEach(lg=>{
              let opt = new Option(lg);
              lga.append(opt);
            })
          }
        }
      }

       // stateContainer.innerHTML = `<h3>States in ${selectedCountry}:</h3><ul>${list}</ul>`;
      })
     /* .catch(err => {
        console.error(err);
        //stateContainer.innerHTML = "<strong>Error fetching states.</strong>";
      });*/
    }

//assert(5 > 2, "This should pass ✅");
//assert(2 > 5, "This should fail ❌"); // Throws Error
  </script>

</body>
</html>
