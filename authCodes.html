<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Authorization Codes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --primary: #1e40af;
      --secondary: #2563eb;
      --success: #16a34a;
      --danger: #dc2626;
      --bg: #f8fafc;
      --text: #0f172a;
      --border: #e5e7eb;
    }

    * {
      box-sizing: border-box;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 40px;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      max-width: 1000px;
      margin: auto;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.08);
      padding: 24px;
    }

    h1 {
      margin: 0 0 20px;
      font-size: 1.5rem;
      color: var(--primary);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      
    }

    thead {
      background: #f1f5f9;
    }

    th, td {
      padding: 14px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      font-size: 0.95rem;
    }

    th {
      font-weight: 600;
      color: #334155;
    }

    tr:hover {
      background: #f9fafb;
    }

    .status {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status.active {
      background: #dcfce7;
      color: var(--success);
    }

    .status.inactive {
      background: #fee2e2;
      color: var(--danger);
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .btn-generate {
      background: var(--secondary);
      color: #ffffff;
    }

    .btn-generate:hover {
      background: var(--primary);
    }

    .actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-save {
      background: var(--success);
      color: #ffffff;
      padding: 10px 22px;
      font-size: 0.9rem;
      font-weight: 600;
      display: inline-block;
      margin-left: 8px;
    }

    .btn-save:hover {
      opacity: 0.9;
    }

    @media (max-width: 768px) {
      th, td {
        font-size: 0.85rem;
        padding: 10px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Authorization Codes</h1>

    <table>
      <thead>
        <tr>
          <th>Class</th>
          <th>Code</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="authTableBody">
        <!-- Rows generated by JS -->
      </tbody>
    </table>

    <div class="actions">
      <button class="btn-save" id="reset" onclick="saveData()">Reset all</button>
      <button class="btn-save" id="save" onclick="saveData()">Save</button>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
     // import {getDatabase, set, ref, onValue, child, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
      const firebaseConfig = {
  apiKey: "AIzaSyCm_DSZaYVQCt0ubBwRkE9nOTryJayxH0w",
  authDomain: "school-in-the-box.firebaseapp.com",
  projectId: "school-in-the-box",
  storageBucket: "school-in-the-box.firebasestorage.app",
  messagingSenderId: "596350496353",
  appId: "1:596350496353:web:84c66c351700ddf0824420",
  measurementId: "G-3MGCDH4FRF"
};
 
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
    const db = getFirestore(app);
  
let schoolId = "capital";
  let teachersRef = doc(db, schoolId, "teachers");
  let teachersDoc = await getDoc(teachersRef);
  let sectionRef = doc(db, schoolId, "section");
  let sectionDoc = await getDoc(sectionRef);

  
  
  
    /*let auths = [
      { class: "Primary 1", code: "A1X9P", status: "active" },
      { class: "Primary 2", code: "B7Q2L", status: "inactive" },
      { class: "Primary 3", code: "C9M8Z", status: "active" }
    ];*/
  
  let user = auth.currentUser;
  let id = user.email.replace(/@.*/, "");
   let hos = teachersDoc.data()[id];
  
   const authRef = doc(db, schoolId, "db", "auths", id);
  let authDoc = await getDoc(authRef);
  
  const authObj = authDoc.exists()? authDoc.data() : {};
    
 if (sectionDoc.exists()){
   let sections = sectionDoc.data();
     
   let keys = hos.adminV2Functions.quality.resources; // Object.keys(sections);
   authObj.auths??=[];
   if (!authObj.auths.length) keys.forEach(key=>{
       let classes = sections[key].classes;
       classes.forEach((clas, i)=>{
         let auth = {class: clas.trim().toLowerCase(), code: "123"+i, status: "inactive"};
         authObj.auths.push(auth);
      });
   });

 }
  

    const tableBody = document.getElementById("authTableBody");

    function renderTable() {
      tableBody.innerHTML = "";

      authObj.auths.forEach((auth, index) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>${auth.class}</td>
          <td>${auth.code}</td>
          <td>
            <span class="status ${auth.status}">
              ${auth.status}
            </span>
          </td>
          <td>
            <button class="btn-generate" onclick="generateNew(${index})">
              Generate New
            </button>
          </td>
        `;
        
        tr.querySelector(".btn-generate")
        .onclick = e=>generateNew(index)

        tableBody.appendChild(tr);
        tr.onclick = async e=>{
        //  let ds = await queryAuthExact(db, schoolId, auth.class, auth.code, auth.status);
         // console.log(JSON.stringify(ds[0]));
        }
      });
    }

    function generateNew(index) {
      authObj.auths[index].code = generateCode();
      authObj.auths[index].status = "active";
      renderTable();
    }
  
  function resetAll(){
    authObj.auths.forEach((_, i)=> generateNew(i))
  }

    function generateCode() {
      const chars = "123456789";
      let code = "";
      for (let i = 0; i < 5; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    async function saveData() {
      console.log("Saved data:", authObj.auths);
      await setDoc(authRef, authObj);
      // Hook this to Firebase / API / backend
    }
  
  save.onclick = async e=> {
    let presaveTxt = save.innerHTML;
    save.innerHTML = "saving..";
    await saveData();
    save.innerHTML = "saved!";
    setTimeout(_=> save.innerHTML = presaveTxt, 2000);
  }
  reset.onclick = e=> resetAll();

    renderTable();
  
  
  

async function queryAuthExact(db, schoolId, className, code, status) {
  const authObject = {
    class: className,
    code: code,
    status: status
  };

  const q = query(
    collection(db, `${schoolId}/db/auths`),
    where("auths", "array-contains", authObject)
  );

  const snapshot = await getDocs(q);
  return snapshot.docs.map(d => d.data());
}
  </script>

</body>
</html>